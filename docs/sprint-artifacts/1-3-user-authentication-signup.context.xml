<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>User Authentication &amp; Signup</title>
    <status>drafted</status>
    <generatedAt>2025-11-26</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-3-user-authentication-signup.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Founder</asA>
    <iWant>to sign up with email/password or social auth</iWant>
    <soThat>I can securely access the platform</soThat>
    <tasks>
      <task id="1" ac="1,2,3">
        <title>Configure Supabase Auth project</title>
        <subtasks>
          <subtask id="1.1">Create Supabase project or configure existing project for auth</subtask>
          <subtask id="1.2">Enable email/password authentication provider</subtask>
          <subtask id="1.3">Configure Google OAuth provider with client ID/secret</subtask>
          <subtask id="1.4">Set redirect URLs for local dev and production</subtask>
          <subtask id="1.5">Configure JWT claims to include custom `org_id` and `role` via hook or function</subtask>
        </subtasks>
      </task>
      <task id="2" ac="1,2,3,6,7">
        <title>Implement auth service layer in core-api</title>
        <subtasks>
          <subtask id="2.1">Create `services/core-api/src/domain/auth/AuthService.ts`</subtask>
          <subtask id="2.2">Implement `signup(email, password, name)` method: create user, trigger org creation, return session</subtask>
          <subtask id="2.3">Implement `login(email, password)` method: authenticate, return session</subtask>
          <subtask id="2.4">Implement `loginWithOAuth(provider, code)` for Google OAuth callback</subtask>
          <subtask id="2.5">Implement `refreshSession(refresh_token)` with rotation</subtask>
          <subtask id="2.6">Implement `logout()` to invalidate session</subtask>
          <subtask id="2.7">Write unit tests for AuthService methods</subtask>
        </subtasks>
      </task>
      <task id="3" ac="1,2,3,6,7">
        <title>Create auth API routes</title>
        <subtasks>
          <subtask id="3.1">Create `POST /api/v1/auth/signup` route</subtask>
          <subtask id="3.2">Create `POST /api/v1/auth/login` route</subtask>
          <subtask id="3.3">Create `GET /api/v1/auth/oauth/google` for OAuth initiation</subtask>
          <subtask id="3.4">Create `GET /api/v1/auth/oauth/callback` for OAuth callback handling</subtask>
          <subtask id="3.5">Create `POST /api/v1/auth/refresh` route</subtask>
          <subtask id="3.6">Create `POST /api/v1/auth/logout` route</subtask>
          <subtask id="3.7">Set HTTP-only cookie with `access_token` on successful auth</subtask>
          <subtask id="3.8">Return Problem Details format for errors (400, 401, 403)</subtask>
          <subtask id="3.9">Write integration tests for all auth routes</subtask>
        </subtasks>
      </task>
      <task id="4" ac="8">
        <title>Implement JWT-backed auth middleware</title>
        <subtasks>
          <subtask id="4.1">Update `services/core-api/src/middleware/authMiddleware.ts`: extract/verify JWT, decode claims (sub, org_id, role)</subtask>
          <subtask id="4.2">Update `services/core-api/src/middleware/orgContext.ts`: verify user.org_id matches header, set app.current_org_id from JWT</subtask>
          <subtask id="4.3">Apply auth middleware to protected routes (events, users, etc.)</subtask>
          <subtask id="4.4">Write tests for auth middleware with valid/invalid/expired tokens</subtask>
          <subtask id="4.5">Write tests for org context with JWT-backed validation</subtask>
        </subtasks>
      </task>
      <task id="5" ac="4,5">
        <title>Emit auth events</title>
        <subtasks>
          <subtask id="5.1">Emit `xentri.user.signup.v1` on signup with org_id, user_id, payload</subtask>
          <subtask id="5.2">Emit `xentri.user.login.v1` on login with org_id, user_id, payload</subtask>
          <subtask id="5.3">Reuse EventService from Story 1.2 for event emission</subtask>
          <subtask id="5.4">Write tests verifying events are logged on auth actions</subtask>
        </subtasks>
      </task>
      <task id="6" ac="1,2,3">
        <title>Shell auth integration</title>
        <subtasks>
          <subtask id="6.1">Create `apps/shell/src/pages/login.astro` with login form</subtask>
          <subtask id="6.2">Create `apps/shell/src/pages/signup.astro` with signup form</subtask>
          <subtask id="6.3">Add "Sign in with Google" button using Supabase OAuth flow</subtask>
          <subtask id="6.4">Create `apps/shell/src/middleware/auth.ts` for route protection</subtask>
          <subtask id="6.5">Redirect unauthenticated users to `/login`</subtask>
          <subtask id="6.6">Redirect authenticated users from `/login` to shell homepage</subtask>
          <subtask id="6.7">Style auth pages with Xentri design tokens from packages/ui</subtask>
        </subtasks>
      </task>
      <task id="7" ac="1">
        <title>Password reset flow</title>
        <subtasks>
          <subtask id="7.1">Create `POST /api/v1/auth/reset-password` route to initiate reset</subtask>
          <subtask id="7.2">Create `POST /api/v1/auth/reset-password/confirm` route to complete reset</subtask>
          <subtask id="7.3">Create `apps/shell/src/pages/reset-password.astro` page</subtask>
          <subtask id="7.4">Configure Supabase email templates for password reset</subtask>
          <subtask id="7.5">Write integration tests for reset flow</subtask>
        </subtasks>
      </task>
      <task id="8" ac="1-8">
        <title>Testing and validation</title>
        <subtasks>
          <subtask id="8.1">Write E2E test: signup with email → redirects to shell</subtask>
          <subtask id="8.2">Write E2E test: login with email → redirects to shell</subtask>
          <subtask id="8.3">Write E2E test: Google OAuth flow (mock or real depending on CI)</subtask>
          <subtask id="8.4">Write integration test: auth events are logged correctly</subtask>
          <subtask id="8.5">Write security test: expired token returns 401</subtask>
          <subtask id="8.6">Write security test: invalid org_id in header vs JWT returns 403</subtask>
          <subtask id="8.7">Verify all tests pass: `pnpm run test`</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">Email/password signup creates user and redirects to shell on success (FR1)</ac>
    <ac id="2">Email/password login authenticates user and redirects to shell on success (FR1)</ac>
    <ac id="3">Google OAuth login succeeds and redirects to shell (FR2)</ac>
    <ac id="4">`xentri.user.signup.v1` event logged with `org_id` + `user_id` on new user registration (FR37)</ac>
    <ac id="5">`xentri.user.login.v1` event logged with `org_id` + `user_id` on successful login (FR37)</ac>
    <ac id="6">Sessions use HTTP-only cookies with secure flags; access tokens are short-lived (FR1, FR2)</ac>
    <ac id="7">Refresh token rotation is implemented; old tokens are invalidated on use (FR1, FR2)</ac>
    <ac id="8">JWT claims include `sub` (user_id), `org_id`, and `role`; middleware validates these before setting RLS context (ADR-003)</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Xentri Architecture</title>
        <section>ADR-003: Multi-Tenant Security (RLS &amp; Context)</section>
        <snippet>Middleware verifies user_id (from JWT) is a member of x-org-id. Rejects if false. Service executes set_config('app.current_org_id', $1, true).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Xentri Architecture</title>
        <section>Implementation Patterns - E. Auth Patterns</section>
        <snippet>User Auth: Supabase GoTrue. Access token includes sub, org_id, role. Middleware enforces presence of x-org-id header matching JWT claims.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>APIs and Interfaces - Authentication Endpoints</section>
        <snippet>POST /api/v1/auth/signup returns {user, org, access_token}. POST /api/v1/auth/login returns {user, access_token}. Events: xentri.user.signup.v1, xentri.user.login.v1.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>FR1-FR4: Authentication</section>
        <snippet>Users can create account with email/password or social auth. Users can reset password. System creates Organization on signup.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>services/core-api/src/domain/events/EventService.ts</path>
        <kind>service</kind>
        <symbol>EventService</symbol>
        <lines>35-123</lines>
        <reason>Reuse createEvent method for logging auth events (signup, login)</reason>
      </file>
      <file>
        <path>services/core-api/src/middleware/orgContext.ts</path>
        <kind>middleware</kind>
        <symbol>orgContextMiddleware</symbol>
        <lines>57-102</lines>
        <reason>Modify to validate x-org-id header against JWT claims instead of trusting it blindly</reason>
      </file>
      <file>
        <path>services/core-api/prisma/schema.prisma</path>
        <kind>schema</kind>
        <symbol>User, Organization, Member</symbol>
        <lines>18-62</lines>
        <reason>Core identity tables referenced during auth and org creation</reason>
      </file>
      <file>
        <path>package.json</path>
        <kind>config</kind>
        <symbol>dependencies</symbol>
        <lines>20-32</lines>
        <reason>Verify dependencies: @prisma/client, fastify, etc. Need to add @supabase/supabase-js if missing.</reason>
      </file>
    </code>
    <dependencies>
      <node>
        <package>@supabase/supabase-js</package>
        <version>^2.0.0</version>
      </node>
      <node>
        <package>fastify</package>
        <version>^5.6.2</version>
      </node>
      <node>
        <package>@fastify/cookie</package>
        <version>^9.0.0</version>
      </node>
      <node>
        <package>zod</package>
        <version>^3.24.0</version>
      </node>
      <node>
        <package>prisma</package>
        <version>^7.0.1</version>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="architecture">Auth Provider: Supabase Auth (GoTrue) per architecture decision</constraint>
    <constraint source="ADR-003">JWT Pattern: Access token MUST include `sub`, `org_id`, `role`</constraint>
    <constraint source="ADR-003">RLS Integration: `app.current_org_id` MUST be set from verified JWT claim, not from untrusted headers</constraint>
    <constraint source="tech-spec">Cookie Security: HTTP-only, Secure, SameSite=Lax for access tokens</constraint>
    <constraint source="architecture">Event Naming: `xentri.user.signup.v1`, `xentri.user.login.v1`</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/v1/auth/signup</name>
      <kind>REST endpoint</kind>
      <signature>Request: {email, password, name} | Response: {user, org, access_token}</signature>
      <path>services/core-api/src/routes/auth.ts (to create)</path>
    </interface>
    <interface>
      <name>POST /api/v1/auth/login</name>
      <kind>REST endpoint</kind>
      <signature>Request: {email, password} | Response: {user, access_token}</signature>
      <path>services/core-api/src/routes/auth.ts (to create)</path>
    </interface>
    <interface>
      <name>JWTClaims</name>
      <kind>TypeScript interface</kind>
      <signature>{ sub: string; org_id: string; role: 'owner'|'admin'|'member'; email: string; iat: number; exp: number; }</signature>
      <path>packages/ts-schema/src/auth.ts (to create)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing uses Vitest. Auth tests should verify both success/failure paths and security boundaries (expired tokens, wrong org). E2E tests (Playwright) should cover the full signup flow including redirection. Integration tests should verify event emission.
    </standards>
    <locations>
      <location>services/core-api/src/domain/auth/*.test.ts</location>
      <location>services/core-api/src/routes/*.test.ts</location>
      <location>services/core-api/src/middleware/*.test.ts</location>
      <location>apps/shell/e2e/*.spec.ts</location>
    </locations>
    <ideas>
      <idea ac="1">E2E: Signup with valid email/password creates user and redirects to shell</idea>
      <idea ac="2">E2E: Login with valid credentials redirects to shell</idea>
      <idea ac="4,5">Integration: Signup and Login trigger correct system events with org_id</idea>
      <idea ac="6">Security: Access token cookie is HTTP-only and Secure</idea>
      <idea ac="8">Security: Middleware rejects request with valid token but mismatched x-org-id header</idea>
      <idea ac="8">Security: Middleware accepts request with valid token and matching x-org-id header</idea>
    </ideas>
  </tests>
</story-context>
