<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>6</storyId>
    <title>Thin Vertical Slice (Signup → Brief → Event)</title>
    <status>drafted</status>
    <generatedAt>2025-11-26</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-6-thin-vertical-slice-signup-brief-event.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>a working end-to-end slice from signup to Brief creation</iWant>
    <soThat>I see the product delivering value, not just infrastructure</soThat>
    <tasks>
      <task id="1" ac="1,2">Create Brief data model and storage
        <subtask>1.1 Create briefs table in Prisma schema with org_id, user_id, schema_version, sections (JSONB), completion_status, timestamps</subtask>
        <subtask>1.2 Add RLS policy for briefs table using fail-closed pattern</subtask>
        <subtask>1.3 Create Zod schemas in packages/ts-schema/src/brief.ts for Brief structure (7 sections)</subtask>
        <subtask>1.4 Create Brief service in services/core-api/src/domain/briefs/BriefService.ts</subtask>
        <subtask>1.5 Run Prisma migration and generate client</subtask>
      </task>
      <task id="2" ac="1,2,6">Create Brief API endpoints
        <subtask>2.1 Create POST /api/v1/briefs endpoint to create new Brief draft</subtask>
        <subtask>2.2 Create GET /api/v1/briefs/:id endpoint to fetch Brief by ID</subtask>
        <subtask>2.3 Create GET /api/v1/briefs/current endpoint to fetch current org's Brief</subtask>
        <subtask>2.4 Create PATCH /api/v1/briefs/:id endpoint to update Brief sections</subtask>
        <subtask>2.5 Emit xentri.brief.created.v1 event on Brief creation</subtask>
        <subtask>2.6 Add error handling with visible error messages for event write failures</subtask>
        <subtask>2.7 Write integration tests for Brief endpoints with RLS verification</subtask>
      </task>
      <task id="3" ac="1,3">Create Strategy category landing page
        <subtask>3.1 Create apps/shell/src/pages/strategy/index.astro as Strategy category landing</subtask>
        <subtask>3.2 Create apps/shell/src/components/strategy/BriefSummaryTile.tsx React island</subtask>
        <subtask>3.3 Create apps/shell/src/components/strategy/CreateBriefCTA.tsx for empty state</subtask>
        <subtask>3.4 Wire BriefSummaryTile to GET /api/v1/briefs/current with TanStack Query</subtask>
        <subtask>3.5 Add Strategy category as active in sidebar</subtask>
      </task>
      <task id="4" ac="1,7">Create Brief creation form (guided form fallback)
        <subtask>4.1 Create apps/shell/src/pages/strategy/brief/new.astro Brief creation page</subtask>
        <subtask>4.2 Create apps/shell/src/components/strategy/BriefForm.tsx React island with 7-section wizard</subtask>
        <subtask>4.3 Implement section-by-section form: Identity, Audience, Offerings, Positioning, Operations, Goals, Proof</subtask>
        <subtask>4.4 Add form validation using Zod schemas from ts-schema</subtask>
        <subtask>4.5 On submit: call POST /api/v1/briefs, handle success/error, redirect to Brief view</subtask>
        <subtask>4.6 Add "Save Draft" functionality for partial completion</subtask>
      </task>
      <task id="5" ac="3">Create Brief view page
        <subtask>5.1 Create apps/shell/src/pages/strategy/brief/[id].astro Brief detail page</subtask>
        <subtask>5.2 Create apps/shell/src/components/strategy/BriefView.tsx React island</subtask>
        <subtask>5.3 Display section completion status (draft vs ready)</subtask>
        <subtask>5.4 Add "Edit Section" buttons linking back to form</subtask>
        <subtask>5.5 Style using shadcn/ui components and UX design system</subtask>
      </task>
      <task id="6" ac="2,4">Verify events visible in org-scoped query
        <subtask>6.1 Create GET /api/v1/events?type=xentri.brief.created.v1 query filter</subtask>
        <subtask>6.2 Create simple events timeline component in Strategy page</subtask>
        <subtask>6.3 Verify RLS prevents cross-org event visibility</subtask>
        <subtask>6.4 Write integration test: create Brief in Org A, verify Org B cannot see event</subtask>
      </task>
      <task id="7" ac="1,2,3,4">E2E vertical slice test
        <subtask>7.1 Create Playwright E2E test: fresh signup → navigate to Strategy → create Brief → verify event logged</subtask>
        <subtask>7.2 Add test to CI pipeline</subtask>
        <subtask>7.3 Verify shell FMP &lt; 2s on 3G throttling (NFR1)</subtask>
        <subtask>7.4 Verify event write latency &lt; 100ms (NFR5)</subtask>
        <subtask>7.5 Measure and log brief completion time for readiness tracking</subtask>
      </task>
      <task id="8" ac="6,7">Error handling and edge cases
        <subtask>8.1 Implement toast notification for event write failures with retry button</subtask>
        <subtask>8.2 Add graceful degradation: if Brief API fails, show error state in tile</subtask>
        <subtask>8.3 Implement offline detection: show offline banner when creating Brief offline</subtask>
        <subtask>8.4 Test fallback form works when Co-pilot route is unavailable</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">From a fresh environment, a user can sign up, land in shell, open Strategy category, and create a Brief draft (FR1, FR6, FR10, FR11)</ac>
    <ac id="2">brief_created event is written to system_events and visible via org-scoped event query (FR33, FR34, FR35, FR36, FR37)</ac>
    <ac id="3">Shell shows Brief summary tile post-creation in the Strategy category (FR26, FR12)</ac>
    <ac id="4">Slice runs in dev and CI environment; uses production-like RLS (FR82)</ac>
    <ac id="5">Readiness metrics tracked: brief completion time, event write reliability, shell FMP budget (NFR1, NFR5)</ac>
    <ac id="6">Event write failures surface visibly to user with retry option (edge case)</ac>
    <ac id="7">Fallback to guided form if Co-pilot unavailable (FR11, FR25)</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/architecture.md" title="System Architecture" section="ADR-002, ADR-003" snippet="Event Backbone pattern using append-only system_events table. Fail-closed RLS with set_config('app.current_org_id', ...) pattern for multi-tenant isolation." />
      <doc path="docs/sprint-artifacts/tech-spec-epic-1.md" title="Epic 1 Tech Spec" section="Story 1.6" snippet="Thin vertical slice ACs: signup → Brief creation → event logged. Brief data model, RLS, and event emission requirements." />
      <doc path="docs/prd.md" title="Product Requirements" section="FR10-FR17, FR33-FR37" snippet="Universal Brief captures business DNA in 7 sections. Event Backbone provides audit trail and powers Calm Prompt." />
      <doc path="docs/ux-design-specification.md" title="UX Design Spec" section="4.1, 5.2" snippet="First-time user journey: Sign Up → Strategy Co-pilot → Build Brief. Toast pattern: Do → Toast → Undo window." />
      <doc path="docs/epics.md" title="Epics" section="Epic 1, Story 1.6" snippet="End-to-end flow demonstrating value delivery. Dependencies: Story 1.2 (events), 1.3 (auth), 1.5 (shell)." />
      <doc path="docs/sprint-artifacts/1-5-application-shell-navigation.md" title="Previous Story" section="Learnings" snippet="Clerk IDs for user/org references. RLS context pattern. Nano stores for state. 26 tests passing." />
    </docs>

    <code>
      <file path="packages/ts-schema/src/events.ts" kind="schema" symbol="BriefCreatedPayloadSchema" lines="90-94" reason="Existing brief_created event payload schema. Story needs to emit events matching this schema." />
      <file path="packages/ts-schema/src/events.ts" kind="schema" symbol="EventTypeSchema" lines="11-22" reason="Event type registry includes xentri.brief.created.v1. Used for type-safe event creation." />
      <file path="packages/ts-schema/src/events.ts" kind="schema" symbol="CreateEventSchema" lines="201-215" reason="Event creation input schema with payload validation. Follow this pattern for Brief events." />
      <file path="services/core-api/src/domain/events/EventService.ts" kind="service" symbol="EventService.createEvent" lines="52-123" reason="Event creation pattern: validate, set RLS context, INSERT with transaction. Reuse for Brief events." />
      <file path="services/core-api/src/domain/events/EventService.ts" kind="service" symbol="EventService.listEvents" lines="135-276" reason="Event query pattern with RLS, filtering, pagination. Extend for Brief event queries." />
      <file path="services/core-api/prisma/schema.prisma" kind="schema" symbol="SystemEvent" lines="111-137" reason="Event table structure. Briefs table should follow similar RLS and indexing patterns." />
      <file path="services/core-api/prisma/schema.prisma" kind="schema" symbol="Organization" lines="18-31" reason="Org model - briefs will reference org_id for RLS isolation." />
      <file path="apps/shell/src/stores/navigation.ts" kind="store" symbol="CATEGORIES" lines="25-97" reason="Category definitions with modules. Strategy category active by default. Brief module href at /brief." />
      <file path="apps/shell/src/stores/navigation.ts" kind="store" symbol="$expandedCategory" lines="103-108" reason="Navigation state pattern using nanostores. Follow for Brief state management." />
      <file path="apps/shell/src/layouts/AppShell.astro" kind="layout" reason="Main shell layout. Strategy pages should use this layout for consistent navigation." />
      <file path="services/core-api/src/routes/events.ts" kind="route" reason="Events API routes. Follow pattern for Brief routes registration." />
      <file path="services/core-api/src/middleware/orgContext.ts" kind="middleware" reason="Org context middleware for RLS. Brief routes must use this middleware." />
      <file path="services/core-api/src/middleware/clerkAuth.ts" kind="middleware" reason="Clerk auth middleware. Brief routes require authentication." />
      <file path="apps/shell/src/components/OfflineBanner.tsx" kind="component" reason="Offline detection pattern. Reuse for Brief offline handling." />
    </code>

    <dependencies>
      <node>
        <pkg name="astro" version="^5.16.0" />
        <pkg name="react" version="^19.2.0" />
        <pkg name="nanostores" version="^0.11.4" />
        <pkg name="@nanostores/react" version="^0.8.4" />
        <pkg name="@clerk/astro" version="^2.16.3" />
        <pkg name="@xentri/ts-schema" version="workspace:*" />
        <pkg name="@xentri/ui" version="workspace:*" />
        <pkg name="lucide-react" version="^0.511.0" />
        <pkg name="@prisma/client" version="^7.0.1" />
        <pkg name="zod" version="^3.24.0" />
        <pkg name="vitest" version="^3.0.0" />
        <pkg name="@playwright/test" version="^1.50.0" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Brief creation MUST emit xentri.brief.created.v1 event to system_events table (ADR-002)</constraint>
    <constraint type="security">All Brief queries MUST use fail-closed RLS with set_config('app.current_org_id', ...) pattern (ADR-003)</constraint>
    <constraint type="frontend">Strategy pages are Astro SSG with React islands for interactive Brief components</constraint>
    <constraint type="contract">Brief schema defined in packages/ts-schema and consumed by both shell and core-api</constraint>
    <constraint type="identity">Use Clerk text IDs for user_id and org_id references (not UUIDs)</constraint>
    <constraint type="testing">Add Brief tests without regression to existing 26 tests (ui:10, ts-schema:3, core-api:13)</constraint>
    <constraint type="performance">Shell FMP &lt; 2s on 3G (NFR1), Event write latency &lt; 100ms (NFR5)</constraint>
  </constraints>

  <interfaces>
    <interface name="POST /api/v1/briefs" kind="REST endpoint" path="services/core-api/src/routes/briefs.ts">
      <signature>POST /api/v1/briefs - Create new Brief draft</signature>
      <request>{ sections?: BriefSections, schema_version?: string }</request>
      <response>{ id: string, org_id: string, sections: BriefSections, completion_status: 'draft' | 'complete' }</response>
    </interface>
    <interface name="GET /api/v1/briefs/current" kind="REST endpoint" path="services/core-api/src/routes/briefs.ts">
      <signature>GET /api/v1/briefs/current - Get current org's Brief</signature>
      <response>{ data: Brief | null }</response>
    </interface>
    <interface name="GET /api/v1/briefs/:id" kind="REST endpoint" path="services/core-api/src/routes/briefs.ts">
      <signature>GET /api/v1/briefs/:id - Get Brief by ID</signature>
      <response>{ data: Brief }</response>
    </interface>
    <interface name="PATCH /api/v1/briefs/:id" kind="REST endpoint" path="services/core-api/src/routes/briefs.ts">
      <signature>PATCH /api/v1/briefs/:id - Update Brief sections</signature>
      <request>{ sections?: Partial&lt;BriefSections&gt; }</request>
      <response>{ data: Brief }</response>
    </interface>
    <interface name="EventService.createEvent" kind="service method" path="services/core-api/src/domain/events/EventService.ts:52-123">
      <signature>createEvent(input: CreateEventInput, orgId: string): Promise&lt;EventAckResponse&gt;</signature>
    </interface>
    <interface name="BriefCreatedPayloadSchema" kind="Zod schema" path="packages/ts-schema/src/events.ts:90-94">
      <signature>z.object({ brief_id: z.string(), title: z.string().optional() })</signature>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Vitest for unit and integration tests. Playwright for E2E tests. Test containers for Postgres integration tests.
      Follow existing patterns in services/core-api/src/__tests__/ and packages/ts-schema/src/__tests__/.
      RLS tests must verify cross-org isolation by seeding two orgs and confirming queries are scoped.
      Integration tests should use the postgres-container helper at services/core-api/src/__tests__/helpers/postgres-container.ts.
    </standards>
    <locations>
      <location glob="services/core-api/src/**/*.test.ts" />
      <location glob="packages/ts-schema/src/__tests__/*.test.ts" />
      <location glob="apps/shell/src/**/*.test.ts" />
      <location glob="e2e/**/*.spec.ts" />
    </locations>
    <ideas>
      <idea ac="1">E2E: Fresh signup → navigate to /strategy → click Create Brief → fill form → verify redirect to Brief view</idea>
      <idea ac="2">Integration: Create Brief via API → verify xentri.brief.created.v1 event in system_events</idea>
      <idea ac="2">Integration: Create Brief in Org A → query events as Org B → verify 0 events returned (RLS isolation)</idea>
      <idea ac="3">Component: BriefSummaryTile renders Brief title and section count correctly</idea>
      <idea ac="3">Component: CreateBriefCTA shows when no Brief exists, hides when Brief exists</idea>
      <idea ac="4">Integration: Run Brief creation with production-like RLS policies enabled</idea>
      <idea ac="5">E2E: Measure shell FMP with 3G throttling, assert &lt; 2000ms</idea>
      <idea ac="5">Integration: Measure event write latency, assert &lt; 100ms</idea>
      <idea ac="6">Component: Toast appears on event write failure with retry button</idea>
      <idea ac="7">E2E: Disable Co-pilot route → verify form fallback renders and submits successfully</idea>
    </ideas>
  </tests>
</story-context>
