<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>7</storyId>
    <title>DevOps, Observability, and Test Readiness</title>
    <status>drafted</status>
    <generatedAt>2025-11-27</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-7-devops-observability-test-readiness.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Developer/Operator</asA>
    <iWant>production-ready CI/CD, structured logging with correlation IDs, and deployment automation</iWant>
    <soThat>the system is observable, deployable with zero downtime, and quality gates prevent regressions</soThat>
    <tasks>
      <task id="1" status="partial">
        <name>Enhance CI Pipeline with Quality Gates</name>
        <ac>AC1</ac>
        <subtasks>
          <subtask status="done">1.1 Update ci.yml to run pnpm run lint</subtask>
          <subtask status="done">1.2 Add type check step: pnpm run typecheck</subtask>
          <subtask status="done">1.3 Add unit test step: pnpm run test with coverage</subtask>
          <subtask status="done">1.4 Configure branch protection rules</subtask>
          <subtask status="missing">1.5 Add test coverage threshold check (>70%)</subtask>
          <subtask status="done">1.6 Add CI matrix for Node 24.x</subtask>
        </subtasks>
      </task>
      <task id="2" status="not-started">
        <name>Implement Structured Logging with Pino</name>
        <ac>AC2</ac>
        <subtasks>
          <subtask status="missing">2.1 Configure Pino logger in services/core-api/src/lib/logger.ts</subtask>
          <subtask status="missing">2.2 Add trace_id generation middleware</subtask>
          <subtask status="missing">2.3 Inject trace_id, org_id, user_id into logs via Fastify context</subtask>
          <subtask status="missing">2.4 Configure log levels (error, warn, info, debug)</subtask>
          <subtask status="missing">2.5 Ensure PII scrubbing (email/name redacted)</subtask>
          <subtask status="missing">2.6 Add Pino transport for Astro shell server logs</subtask>
        </subtasks>
      </task>
      <task id="3" status="not-started">
        <name>Integrate Error Tracking</name>
        <ac>AC2</ac>
        <subtasks>
          <subtask status="missing">3.1 Add Sentry SDK to services/core-api</subtask>
          <subtask status="missing">3.2 Configure error boundary capture with context</subtask>
          <subtask status="missing">3.3 Add Sentry SDK to apps/shell</subtask>
          <subtask status="missing">3.4 Configure source maps upload</subtask>
          <subtask status="missing">3.5 Add test for error capture</subtask>
        </subtasks>
      </task>
      <task id="4" status="partial">
        <name>Create Smoke Test Script</name>
        <ac>AC3</ac>
        <subtasks>
          <subtask status="missing">4.1 Extend smoke-test.ts for signup → Brief → event flow</subtask>
          <subtask status="done">4.2 Add health check endpoints (/health, /health/ready)</subtask>
          <subtask status="done">4.3 Verify smoke test checks RLS isolation</subtask>
          <subtask status="done">4.4 Integrate smoke test into CI pipeline</subtask>
          <subtask status="missing">4.5 Add timing assertions (shell FMP &lt;2s, API &lt;300ms)</subtask>
        </subtasks>
      </task>
      <task id="5" status="done">
        <name>Railway Deployment Configuration</name>
        <ac>AC4</ac>
        <subtasks>
          <subtask status="done">5.1 Create services/core-api/railway.toml</subtask>
          <subtask status="done">5.2 Create apps/shell/railway.toml</subtask>
          <subtask status="done">5.3 Document environment variables in deployment-plan.md</subtask>
          <subtask status="done">5.4 Configure zero-downtime deploys</subtask>
          <subtask status="done">5.5 Add Railway-specific Dockerfile optimizations</subtask>
          <subtask status="done">5.6 Create k8s-migration-runbook.md stub</subtask>
        </subtasks>
      </task>
      <task id="6" status="not-started">
        <name>Observability Infrastructure</name>
        <ac>AC2, AC3</ac>
        <subtasks>
          <subtask status="missing">6.1 Add OpenTelemetry SDK to core-api</subtask>
          <subtask status="missing">6.2 Configure traceparent header propagation</subtask>
          <subtask status="missing">6.3 Add metrics endpoint /api/v1/metrics</subtask>
          <subtask status="missing">6.4 Document in docs/observability.md</subtask>
          <subtask status="missing">6.5 Verify trace_id flows shell → core-api → DB</subtask>
        </subtasks>
      </task>
      <task id="7" status="partial">
        <name>Testing Infrastructure Hardening</name>
        <ac>AC1, AC3</ac>
        <subtasks>
          <subtask status="done">7.1 Configure Vitest with coverage reporter (v8)</subtask>
          <subtask status="missing">7.2 Add coverage thresholds (70%) to vitest.config.ts</subtask>
          <subtask status="done">7.3 Create test utilities for auth mocking</subtask>
          <subtask status="done">7.4 Add integration test for RLS cross-org isolation</subtask>
          <subtask status="missing">7.5 Document test strategy in docs/testing-strategy.md</subtask>
        </subtasks>
      </task>
      <task id="8" status="partial">
        <name>Documentation and Runbooks</name>
        <ac>AC4</ac>
        <subtasks>
          <subtask status="done">8.1 Create docs/deployment-plan.md</subtask>
          <subtask status="done">8.2 Create docs/architecture/adr-004-railway-bootstrap.md</subtask>
          <subtask status="done">8.3 Create docs/k8s-migration-runbook.md</subtask>
          <subtask status="missing">8.4 Add docs/incident-response.md stub</subtask>
          <subtask status="missing">8.5 Update CLAUDE.md with deployment commands</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1" status="partial">
      <description>CI runs lint + unit tests + type checks on PRs; failing checks block merge (FR82, NFR29)</description>
      <evidence>CI pipeline exists with lint/typecheck/test jobs, but missing >70% coverage threshold check</evidence>
    </criterion>
    <criterion id="AC2" status="not-met">
      <description>Logging uses structured JSON with correlation IDs (trace_id, org_id, user_id); error tracking hooked to capture exceptions (NFR24, NFR25)</description>
      <evidence>server.ts uses default Fastify logger without trace_id/org_id/user_id injection; logger.ts missing; Sentry not integrated</evidence>
    </criterion>
    <criterion id="AC3" status="partial">
      <description>Minimal smoke test script validates shell + Brief slice in CI environment (NFR26)</description>
      <evidence>Smoke test exists and tests RLS isolation, but missing signup→Brief→event flow and timing assertions</evidence>
    </criterion>
    <criterion id="AC4" status="met">
      <description>Deployment pipeline supports zero-downtime deploys via Railway Config as Code (ADR-004)</description>
      <evidence>railway.toml files exist for core-api and shell; deployment-plan.md and ADR-004 documented</evidence>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Xentri Architecture</title>
        <section>Cross-Cutting Concerns (Section 7)</section>
        <snippet>Logging: Centralized structured logging (JSON) with trace_id propagation. Observability: OpenTelemetry traces across shell/services; logs to Loki/Grafana; metrics via Prometheus.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Xentri Architecture</title>
        <section>ADR-004: Railway Bootstrap Deployment Strategy</section>
        <snippet>Bridge Strategy: deploy to Railway (PaaS) for bootstrapping, migrate to Kubernetes when triggered by spend ($500/mo) or compliance requirements. Config as Code via railway.toml.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Foundation &amp; Access</title>
        <section>Story 1.7 Acceptance Criteria</section>
        <snippet>CI runs lint + unit tests + type checks on PRs; fails gate merges. Logging uses structured JSON with correlation IDs. Deployment pipeline supports zero-downtime deploys.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Foundation &amp; Access</title>
        <section>Observability (Non-Functional Requirements)</section>
        <snippet>NFR24: Structured logging (Pino JSON with correlation IDs). NFR25: Error tracking (exception capture with stack traces). NFR26: Performance monitoring (OpenTelemetry traces). NFR29: >70% test coverage.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Xentri Epic Breakdown</title>
        <section>Story 1.7: DevOps, Observability, and Test Readiness</section>
        <snippet>Deployment Strategy (ADR-004): Bridge Strategy - Railway for bootstrapping → K8s when spend >$500/mo. Artifacts: adr-004-railway-bootstrap.md, deployment-plan.md, k8s-migration-runbook.md.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>services/core-api/src/server.ts</path>
        <kind>server</kind>
        <symbol>Fastify server configuration</symbol>
        <lines>14-25</lines>
        <reason>Main server using default Fastify logger - needs custom Pino logger with correlation IDs</reason>
      </artifact>
      <artifact>
        <path>services/core-api/src/routes/health.ts</path>
        <kind>routes</kind>
        <symbol>healthRoutes</symbol>
        <lines>1-33</lines>
        <reason>Health endpoints (/health, /health/ready) already implemented - reuse pattern for metrics endpoint</reason>
      </artifact>
      <artifact>
        <path>.github/workflows/ci.yml</path>
        <kind>ci</kind>
        <symbol>CI pipeline</symbol>
        <lines>1-242</lines>
        <reason>Existing CI with lint/typecheck/test/build/smoke jobs - needs coverage threshold step added</reason>
      </artifact>
      <artifact>
        <path>scripts/smoke-test.ts</path>
        <kind>test</kind>
        <symbol>smoke test script</symbol>
        <lines>1-427</lines>
        <reason>Validates RLS isolation - needs extension for signup→Brief→event flow and timing assertions</reason>
      </artifact>
      <artifact>
        <path>vitest.config.ts</path>
        <kind>config</kind>
        <symbol>Vitest configuration</symbol>
        <lines>1-18</lines>
        <reason>Coverage provider configured (v8) but missing threshold enforcement</reason>
      </artifact>
      <artifact>
        <path>services/core-api/railway.toml</path>
        <kind>config</kind>
        <symbol>Railway deployment config</symbol>
        <lines>all</lines>
        <reason>Deployment configuration already exists - verify health check path alignment</reason>
      </artifact>
      <artifact>
        <path>apps/shell/railway.toml</path>
        <kind>config</kind>
        <symbol>Railway deployment config</symbol>
        <lines>all</lines>
        <reason>Shell deployment configuration - verify Astro build settings</reason>
      </artifact>
      <artifact>
        <path>services/core-api/src/__tests__/health.test.ts</path>
        <kind>test</kind>
        <symbol>health route tests</symbol>
        <lines>all</lines>
        <reason>Existing test pattern for health endpoint - follow for metrics tests</reason>
      </artifact>
      <artifact>
        <path>apps/shell/src/utils/metrics.ts</path>
        <kind>utility</kind>
        <symbol>client-side metrics</symbol>
        <lines>all</lines>
        <reason>Story 1.6 created FCP/timing capture utility - extend for observability integration</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="fastify" version="^5.6.2" />
        <package name="@fastify/cors" version="^11.0.0" />
        <package name="@fastify/helmet" version="^13.0.0" />
        <package name="@clerk/fastify" version="^2.6.5" />
        <package name="@prisma/client" version="^7.0.1" />
        <package name="vitest" version="^3.0.0" />
        <package name="tsx" version="^4.19.0" />
        <package name="typescript" version="^5.8.3" />
        <package name="@testcontainers/postgresql" version="^10.18.0" />
      </ecosystem>
      <ecosystem name="shell">
        <package name="astro" version="^5.16.0" />
        <package name="@astrojs/react" version="^4.3.1" />
        <package name="@clerk/astro" version="^2.16.3" />
        <package name="react" version="^19.2.0" />
      </ecosystem>
      <toAdd>
        <package name="pino" version="^10.1.0" purpose="Structured JSON logging" />
        <package name="pino-pretty" version="^13.0.0" purpose="Dev log formatting (devDep)" />
        <package name="@sentry/node" version="latest" purpose="Error tracking for core-api" />
        <package name="@sentry/astro" version="latest" purpose="Error tracking for shell" />
        <package name="@opentelemetry/sdk-node" version="latest" purpose="Trace propagation (optional)" />
      </toAdd>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="docs/architecture.md">Use Pino JSON logs with trace_id, org_id, user_id propagation for all services</constraint>
    <constraint source="docs/architecture.md">OpenTelemetry traces across shell/services via traceparent header</constraint>
    <constraint source="docs/architecture.md">All settings in railway.toml files - no clickops drift (ADR-004)</constraint>
    <constraint source="docs/sprint-artifacts/tech-spec-epic-1.md">PRs blocked on failing lint/test/typecheck - CI quality gates</constraint>
    <constraint source="docs/sprint-artifacts/tech-spec-epic-1.md">Error tracking with stack traces (NFR25)</constraint>
    <constraint source="docs/sprint-artifacts/tech-spec-epic-1.md">PII scrubbing: email/name redacted from logs (NFR11)</constraint>
    <constraint source="docs/sprint-artifacts/tech-spec-epic-1.md">Performance budgets: shell FMP &lt;2s, API p95 &lt;300ms (NFR1)</constraint>
    <constraint source="CLAUDE.md">Follow ultrathink principles - craft elegant solutions, iterate relentlessly</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /health</name>
      <kind>REST endpoint</kind>
      <signature>GET /health → { status: 'ok' }</signature>
      <path>services/core-api/src/routes/health.ts</path>
    </interface>
    <interface>
      <name>GET /health/ready</name>
      <kind>REST endpoint</kind>
      <signature>GET /health/ready → { status: 'ok'|'degraded', checks: { database: 'ok'|'error' } }</signature>
      <path>services/core-api/src/routes/health.ts</path>
    </interface>
    <interface>
      <name>Fastify Logger</name>
      <kind>module interface</kind>
      <signature>server.log.info/warn/error(message) with request context</signature>
      <path>services/core-api/src/server.ts</path>
    </interface>
    <interface>
      <name>createRequestLogger (to implement)</name>
      <kind>function signature</kind>
      <signature>createRequestLogger(req: FastifyRequest) → Logger.child({ trace_id, org_id, user_id })</signature>
      <path>services/core-api/src/lib/logger.ts (to create)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Unit tests use Vitest (v3.0.0) with v8 coverage provider. Tests are co-located with source as *.test.ts files or in __tests__ directories. Integration tests use testcontainers for PostgreSQL. E2E tests planned but not yet implemented. Test environment requires RUN_TESTCONTAINERS=1 for container-gated tests. Auth mocking uses Clerk session fixtures.
    </standards>
    <locations>
      <location>services/core-api/src/**/*.test.ts</location>
      <location>services/core-api/src/__tests__/**/*.ts</location>
      <location>packages/ts-schema/src/__tests__/**/*.ts</location>
      <location>scripts/smoke-test.ts</location>
    </locations>
    <ideas>
      <idea ac="AC1">Test that CI fails when coverage drops below 70% threshold</idea>
      <idea ac="AC1">Verify branch protection blocks merge on failing checks</idea>
      <idea ac="AC2">Test logger outputs JSON with trace_id, org_id, user_id fields</idea>
      <idea ac="AC2">Test PII (email, name) is redacted from log output</idea>
      <idea ac="AC2">Test error tracking captures exceptions with context</idea>
      <idea ac="AC2">Test trace_id propagates from request header through to logs</idea>
      <idea ac="AC3">Test smoke script covers signup → Brief → event flow</idea>
      <idea ac="AC3">Test timing assertions: shell FMP &lt;2s, API response &lt;300ms</idea>
      <idea ac="AC4">Test health endpoint returns correct status for Railway health checks</idea>
      <idea ac="AC4">Verify railway.toml configurations match deployment requirements</idea>
    </ideas>
  </tests>
</story-context>
