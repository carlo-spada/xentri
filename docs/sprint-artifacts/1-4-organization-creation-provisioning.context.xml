<story-context id="1-4-organization-creation-provisioning" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>4</storyId>
    <title>Organization Creation &amp; Provisioning</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-26</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-4-organization-creation-provisioning.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>New User</asA>
    <iWant>an Organization created for me automatically upon signup with proper provisioning</iWant>
    <soThat>I have a private, fully-configured workspace for my business data</soThat>
    <tasks>
      <task id="1" acs="1,5,6,7">Create org provisioning service
        <subtask>1.1 Create services/core-api/src/domain/orgs/OrgProvisioningService.ts</subtask>
        <subtask>1.2 Implement provisionOrg(clerkOrgId, clerkUserId, orgName) method</subtask>
        <subtask>1.3 Add idempotency check: if org exists with same Clerk ID, skip creation</subtask>
        <subtask>1.4 Initialize org_settings record with defaults (plan: 'free', features: {}, preferences: {})</subtask>
        <subtask>1.5 Wrap provisioning in transaction with rollback on failure</subtask>
        <subtask>1.6 Write unit tests for OrgProvisioningService</subtask>
      </task>
      <task id="2" acs="2,3,6">Create memberships table and model
        <subtask>2.1 Add Prisma migration: memberships table</subtask>
        <subtask>2.2 Add RLS policy: users can only see memberships for orgs they belong to</subtask>
        <subtask>2.3 Add unique constraint: (org_id, user_id)</subtask>
        <subtask>2.4 Create MembershipRole enum: owner, admin, member</subtask>
        <subtask>2.5 Add memberships model to Prisma schema</subtask>
        <subtask>2.6 Write RLS isolation test for memberships</subtask>
      </task>
      <task id="3" acs="5,6">Create org_settings table and model
        <subtask>3.1 Add Prisma migration: org_settings table</subtask>
        <subtask>3.2 Add RLS policy: org members can read, owners can write</subtask>
        <subtask>3.3 Add unique constraint: one settings record per org</subtask>
        <subtask>3.4 Add org_settings model to Prisma schema</subtask>
        <subtask>3.5 Write RLS isolation test for org_settings</subtask>
      </task>
      <task id="4" acs="1,2,3,4,6,7">Enhance Clerk webhook handler
        <subtask>4.1 Update organization.created webhook to call OrgProvisioningService.provisionOrg()</subtask>
        <subtask>4.2 Create local membership record (owner role) after org provisioning</subtask>
        <subtask>4.3 Emit xentri.org.provisioned.v1 event after full provisioning</subtask>
        <subtask>4.4 Add idempotency: check if membership already exists before creating</subtask>
        <subtask>4.5 Handle organization.membership.created webhook for future multi-user support</subtask>
        <subtask>4.6 Add error handling with retry queue for failed provisioning</subtask>
        <subtask>4.7 Write tests for enhanced webhook handlers</subtask>
      </task>
      <task id="5" acs="1,5">Add org provisioning API endpoints
        <subtask>5.1 Create GET /api/v1/orgs/current - returns current org with settings</subtask>
        <subtask>5.2 Create PATCH /api/v1/orgs/current/settings - update org preferences (owner only)</subtask>
        <subtask>5.3 Add Clerk auth middleware to org routes</subtask>
        <subtask>5.4 Add Zod schemas for org settings request/response to ts-schema</subtask>
        <subtask>5.5 Write integration tests for org endpoints</subtask>
      </task>
      <task id="6" acs="4,5">Update ts-schema with org types
        <subtask>6.1 Add OrgSettings schema to packages/ts-schema/src/orgs.ts</subtask>
        <subtask>6.2 Add MembershipRole enum to packages/ts-schema/src/orgs.ts</subtask>
        <subtask>6.3 Add xentri.org.provisioned.v1 event type to packages/ts-schema/src/events.ts</subtask>
        <subtask>6.4 Export new types from packages/ts-schema/src/index.ts</subtask>
        <subtask>6.5 Run typecheck to verify no regressions</subtask>
      </task>
      <task id="7" acs="1-7">Testing and validation
        <subtask>7.1 Write integration test: new user signup triggers full provisioning flow</subtask>
        <subtask>7.2 Write integration test: replaying webhook is idempotent</subtask>
        <subtask>7.3 Write integration test: partial failure rolls back cleanly</subtask>
        <subtask>7.4 Write RLS test: org_settings isolated by org</subtask>
        <subtask>7.5 Write RLS test: memberships isolated by org</subtask>
        <subtask>7.6 Verify all existing tests pass (12+ Clerk tests from 1.3)</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1" fr="FR6">On new user signup, an Organization record is automatically created with default settings</criterion>
    <criterion id="AC2" fr="FR6">New user is assigned as "Owner" of that org with full permissions</criterion>
    <criterion id="AC3" fr="FR6">Local memberships table links user to org with role: 'owner'</criterion>
    <criterion id="AC4" fr="FR37">xentri.org.provisioned.v1 event logged after full provisioning completes</criterion>
    <criterion id="AC5" fr="FR6">Org settings initialized with defaults: plan: 'free', features: {}, preferences: {}</criterion>
    <criterion id="AC6" fr="FR6">Provisioning is idempotentâ€”replaying the webhook does not create duplicate orgs or memberships</criterion>
    <criterion id="AC7" fr="FR6">Failed provisioning triggers retry with exponential backoff; partial state is recoverable</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/architecture.md" title="Xentri Architecture" section="ADR-003: Multi-Tenant Security">
        RLS with fail-closed transaction pattern. Middleware verifies user_id from JWT is member of x-org-id. Transaction sets app.current_org_id.
      </doc>
      <doc path="docs/architecture.md" title="Xentri Architecture" section="Auth Patterns">
        Clerk for sign-in/up with native Organizations support. Access token includes sub, org_id, org_role, org_permissions.
      </doc>
      <doc path="docs/architecture.md" title="Xentri Architecture" section="ADR-002: Event Envelope">
        Strict SystemEvent envelope with namespaced types (xentri.{context}.{action}.{version}), versioning, and PII hygiene.
      </doc>
      <doc path="docs/epics.md" title="Epic Breakdown" section="Story 1.4">
        On new user signup, Organization record created (FR6). User assigned as Owner. org_created event logged.
      </doc>
      <doc path="docs/sprint-artifacts/tech-spec-epic-1.md" title="Epic 1 Tech Spec" section="Story 1.4">
        High-level requirements for org creation. This story refines to xentri.org.provisioned.v1 event and detailed provisioning.
      </doc>
      <doc path="docs/sprint-artifacts/1-3-user-authentication-signup.md" title="Story 1.3" section="Completion Notes">
        Clerk webhooks handle user/org sync. 12 tests passing. String IDs (not UUIDs). EventService available.
      </doc>
    </docs>

    <code>
      <file path="services/core-api/src/routes/webhooks/clerk.ts" kind="webhook-handler" lines="116-209" reason="EXTEND: handleOrganizationCreated already syncs org and creates Member. Add OrgProvisioningService call and org.provisioned event.">
        <symbol>handleOrganizationCreated</symbol>
        <note>Currently creates org via prisma.organization.upsert and member via prisma.member.upsert. Emits xentri.org.created.v1. Extend to call OrgProvisioningService for settings and xentri.org.provisioned.v1.</note>
      </file>
      <file path="services/core-api/src/domain/events/EventService.ts" kind="service" lines="52-123" reason="REUSE: createEvent method for emitting xentri.org.provisioned.v1 event">
        <symbol>EventService.createEvent</symbol>
        <note>Validates via Zod, generates dedupe_key, executes in transaction with RLS context. Use same pattern.</note>
      </file>
      <file path="services/core-api/prisma/schema.prisma" kind="schema" lines="46-70" reason="EXTEND: Add org_settings model. Member model already exists with MemberRole enum.">
        <symbol>Member, MemberRole, Organization</symbol>
        <note>Member table exists with owner/admin/member roles and unique(orgId, userId). Organization uses String @id. Add OrgSettings model following same pattern.</note>
      </file>
      <file path="packages/ts-schema/src/events.ts" kind="types" lines="11-21" reason="EXTEND: Add xentri.org.provisioned.v1 to EventTypeSchema enum">
        <symbol>EventTypeSchema, EventPayloadSchemas</symbol>
        <note>Add OrgProvisionedPayloadSchema with org_id, org_name, owner_user_id, plan, provisioned_at fields.</note>
      </file>
      <file path="packages/ts-schema/src/events.ts" kind="types" lines="68-73" reason="REFERENCE: OrgCreatedPayloadSchema pattern for OrgProvisionedPayloadSchema">
        <symbol>OrgCreatedPayloadSchema</symbol>
        <note>Pattern: z.object with name, slug, owner_id. Extend for provisioned event.</note>
      </file>
      <file path="services/core-api/src/middleware/clerkAuth.ts" kind="middleware" reason="REUSE: Use clerkAuthMiddleware for org routes authentication">
        <symbol>clerkAuthMiddleware</symbol>
        <note>Extracts userId, orgId, orgRole from Clerk session. Apply to /api/v1/orgs routes.</note>
      </file>
      <file path="services/core-api/src/infra/db.ts" kind="utility" reason="REUSE: getPrisma for database access">
        <symbol>getPrisma</symbol>
        <note>Singleton Prisma client with pg adapter. Use in OrgProvisioningService.</note>
      </file>
    </code>

    <dependencies>
      <ecosystem name="node">
        <package name="@prisma/client" version="^7.0.1" />
        <package name="@clerk/fastify" version="^2.6.5" />
        <package name="fastify" version="^5.6.2" />
        <package name="zod" version="^3.24.0" />
        <package name="svix" version="^1.52.0" />
        <package name="vitest" version="^3.0.0" dev="true" />
        <package name="@testcontainers/postgresql" version="^10.18.0" dev="true" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface name="EventService.createEvent" kind="service-method" path="services/core-api/src/domain/events/EventService.ts:52">
      <signature>async createEvent(input: CreateEventInput, orgId: string): Promise&lt;EventAckResponse&gt;</signature>
      <note>Use for emitting xentri.org.provisioned.v1 event</note>
    </interface>
    <interface name="prisma.organization.upsert" kind="prisma-method" path="services/core-api/prisma/schema.prisma:18">
      <signature>prisma.organization.upsert({ where: { id }, update: {...}, create: {...} })</signature>
      <note>Existing pattern in webhook handler for idempotent org creation</note>
    </interface>
    <interface name="prisma.member.upsert" kind="prisma-method" path="services/core-api/prisma/schema.prisma:47">
      <signature>prisma.member.upsert({ where: { orgId_userId: { orgId, userId } }, update: {...}, create: {...} })</signature>
      <note>Existing pattern in webhook handler for idempotent membership creation</note>
    </interface>
    <interface name="Clerk Webhook organization.created" kind="webhook" path="services/core-api/src/routes/webhooks/clerk.ts:328">
      <signature>event.type === 'organization.created' -&gt; handleOrganizationCreated(data)</signature>
      <note>Entry point for org provisioning. Extend this handler.</note>
    </interface>
    <interface name="GET /api/v1/orgs/current" kind="REST" path="NEW">
      <signature>GET /api/v1/orgs/current -&gt; { org: Organization, settings: OrgSettings }</signature>
      <note>New endpoint returning current org with settings. Requires Clerk auth.</note>
    </interface>
    <interface name="PATCH /api/v1/orgs/current/settings" kind="REST" path="NEW">
      <signature>PATCH /api/v1/orgs/current/settings { preferences: {...} } -&gt; { settings: OrgSettings }</signature>
      <note>New endpoint for updating org preferences. Owner only.</note>
    </interface>
  </interfaces>

  <constraints>
    <constraint source="docs/architecture.md#ADR-003">RLS fail-closed: All new tables MUST have RLS policies that check app.current_org_id is NOT NULL</constraint>
    <constraint source="docs/architecture.md#ADR-002">Events use namespaced types: xentri.org.provisioned.v1</constraint>
    <constraint source="docs/sprint-artifacts/1-3-user-authentication-signup.md">String IDs: User and Organization use Clerk string IDs, not UUIDs. New tables must follow.</constraint>
    <constraint source="docs/architecture.md#Auth-Patterns">Clerk-first: Org creation triggered by webhook, not direct API call</constraint>
    <constraint source="Clerk docs">Webhook idempotency: Handlers MUST be idempotent due to Clerk retry behavior</constraint>
    <constraint source="docs/sprint-artifacts/1-3-user-authentication-signup.md">RLS pattern: Use current_setting('app.current_org_id', true) without ::uuid cast</constraint>
    <constraint source="Story requirement">Transaction safety: Provisioning must wrap in transaction with rollback on failure</constraint>
  </constraints>

  <tests>
    <standards>
      Vitest 3.0 for unit and integration tests. Tests co-located as *.test.ts next to source files.
      Testcontainers for Postgres integration tests requiring real database.
      Mock Clerk webhooks in tests using custom request builders.
      RLS isolation tests verify cross-org reads return empty results.
      12+ existing Clerk tests must continue passing.
    </standards>
    <locations>
      <location>services/core-api/src/**/*.test.ts</location>
      <location>services/core-api/src/__tests__/</location>
      <location>packages/ts-schema/src/**/*.test.ts</location>
    </locations>
    <ideas>
      <idea ac="AC1,AC5">Test: provisionOrg creates org with default settings (plan: free, empty features/preferences)</idea>
      <idea ac="AC2,AC3">Test: provisionOrg creates membership with role: owner</idea>
      <idea ac="AC4">Test: provisionOrg emits xentri.org.provisioned.v1 event with correct payload</idea>
      <idea ac="AC6">Test: calling provisionOrg twice with same clerkOrgId is idempotent (no duplicates)</idea>
      <idea ac="AC6">Test: replaying organization.created webhook creates no duplicates</idea>
      <idea ac="AC7">Test: partial provisioning failure rolls back transaction cleanly</idea>
      <idea ac="AC3">Test: RLS isolation - org A cannot see org B memberships</idea>
      <idea ac="AC5">Test: RLS isolation - org A cannot see org B settings</idea>
      <idea ac="AC5">Test: GET /api/v1/orgs/current returns org with settings</idea>
      <idea ac="AC5">Test: PATCH /api/v1/orgs/current/settings updates preferences (owner only)</idea>
      <idea ac="AC5">Test: PATCH /api/v1/orgs/current/settings rejects non-owner</idea>
    </ideas>
  </tests>
</story-context>
