<story-context id="1-5-application-shell-navigation" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>5</storyId>
    <title>Application Shell & Navigation</title>
    <status>drafted</status>
    <generatedAt>2025-11-26</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-5-application-shell-navigation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Logged-in User</asA>
    <iWant>a stable application shell with 7-category sidebar navigation, theme toggle, and responsive mobile layout</iWant>
    <soThat>I can navigate between Xentri capabilities seamlessly without page reloads and have a consistent experience across devices</soThat>
    <tasks>
      <task id="1" title="Implement Shell layout structure" acs="1,2,7">
        <subtask>1.1 Create apps/shell/src/layouts/AppShell.astro with header + sidebar + content area slots</subtask>
        <subtask>1.2 Create apps/shell/src/components/Header.astro with logo, user menu trigger, notification bell</subtask>
        <subtask>1.3 Create apps/shell/src/components/Sidebar.astro with 7 category icons and expand/collapse logic</subtask>
        <subtask>1.4 Add responsive breakpoint handling: full sidebar (≥1024px), collapsed icons (768-1023px), mobile drawer (&lt;768px)</subtask>
        <subtask>1.5 Ensure all touch targets are ≥44px on mobile using Tailwind classes</subtask>
      </task>
      <task id="2" title="Implement sidebar accordion navigation" acs="3,4,5">
        <subtask>2.1 Create apps/shell/src/components/SidebarCategory.tsx React island for interactive expand/collapse</subtask>
        <subtask>2.2 Implement accordion behavior: clicking category expands it, collapses others</subtask>
        <subtask>2.3 Create Nano Store apps/shell/src/stores/navigation.ts for sidebar state</subtask>
        <subtask>2.4 Add disabled/locked state styling for inactive categories</subtask>
        <subtask>2.5 Implement hover prefetching with client:visible and manual prefetch on hover</subtask>
        <subtask>2.6 Write unit tests for navigation store state transitions</subtask>
      </task>
      <task id="3" title="Implement user menu with theme toggle" acs="1,6">
        <subtask>3.1 Create apps/shell/src/components/UserMenu.tsx React island with dropdown</subtask>
        <subtask>3.2 Add theme toggle (Light/Dark/System) using Nano Store apps/shell/src/stores/theme.ts</subtask>
        <subtask>3.3 Implement theme persistence: save to user_preferences.theme via API call on change</subtask>
        <subtask>3.4 Load theme preference on app init from user session data</subtask>
        <subtask>3.5 Apply theme class to html element using Tailwind dark mode</subtask>
        <subtask>3.6 Add user avatar, name display, and sign-out action to menu</subtask>
        <subtask>3.7 Write unit tests for theme store and persistence logic</subtask>
      </task>
      <task id="4" title="Create user preferences API endpoint" acs="6">
        <subtask>4.1 Create PATCH /api/v1/users/me/preferences endpoint in services/core-api/src/routes/users.ts</subtask>
        <subtask>4.2 Add request validation: { theme?: 'light' | 'dark' | 'system', email_notifications?: object }</subtask>
        <subtask>4.3 Implement upsert to user_preferences table with RLS enforcement</subtask>
        <subtask>4.4 Add GET /api/v1/users/me enhancement to include preferences in response</subtask>
        <subtask>4.5 Add Zod schemas to packages/ts-schema/src/users.ts for preferences</subtask>
        <subtask>4.6 Write integration tests for preferences endpoint</subtask>
      </task>
      <task id="5" title="Implement notification bell UI" acs="1">
        <subtask>5.1 Create apps/shell/src/components/NotificationBell.tsx React island with badge count</subtask>
        <subtask>5.2 Implement dropdown showing recent notifications (stub data for now)</subtask>
        <subtask>5.3 Add unread count badge that updates from notifications API</subtask>
        <subtask>5.4 Create Nano Store apps/shell/src/stores/notifications.ts for notification state</subtask>
        <subtask>5.5 Wire to GET /api/v1/notifications?unread_only=true</subtask>
      </task>
      <task id="6" title="Implement offline banner and PWA basics" acs="8">
        <subtask>6.1 Create apps/shell/src/components/OfflineBanner.astro component</subtask>
        <subtask>6.2 Add service worker registration in apps/shell/src/scripts/sw-register.ts</subtask>
        <subtask>6.3 Implement network status detection using navigator.onLine + online/offline events</subtask>
        <subtask>6.4 Cache shell HTML and critical assets for offline navigation</subtask>
        <subtask>6.5 Display banner: "You're offline. Some features may be limited." with retry button</subtask>
      </task>
      <task id="7" title="Client-side routing setup" acs="5,9">
        <subtask>7.1 Configure Astro View Transitions for smooth navigation</subtask>
        <subtask>7.2 Add transition:animate directives to content area for seamless switches</subtask>
        <subtask>7.3 Implement hover prefetch via data-astro-prefetch="hover" on sidebar links</subtask>
        <subtask>7.4 Preserve scroll position and form state across navigations</subtask>
        <subtask>7.5 Write E2E test: navigate between categories, verify no full reload</subtask>
      </task>
      <task id="8" title="Integration and testing" acs="1-9">
        <subtask>8.1 Write E2E test: sidebar accordion behavior (expand/collapse)</subtask>
        <subtask>8.2 Write E2E test: theme toggle persists across sessions</subtask>
        <subtask>8.3 Write E2E test: mobile responsive behavior (drawer open/close)</subtask>
        <subtask>8.4 Write E2E test: offline banner appears when network disconnected</subtask>
        <subtask>8.5 Verify shell loads in &lt;2s on simulated 3G (NFR1)</subtask>
        <subtask>8.6 Run accessibility audit (WCAG 2.1 AA) on shell components</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1" fr="FR26">Shell displays stable header with user avatar menu and notification bell icon</ac>
    <ac id="2" fr="FR27">Shell displays collapsible sidebar with 7 category icons: Management &amp; Strategy, Brand &amp; Marketing, Sales &amp; Relationships, Finance &amp; Accounting, Operations &amp; Delivery, Team &amp; Leadership, Legal &amp; Compliance</ac>
    <ac id="3" fr="FR28">Only subscribed/active categories are interactable; inactive categories show as disabled/locked</ac>
    <ac id="4" fr="FR29">Clicking a category expands its subcategories; other expanded categories collapse (accordion behavior)</ac>
    <ac id="5" fr="FR30">Switching between categories/modules does not trigger full page reload; navigation uses client-side routing</ac>
    <ac id="6" fr="FR31">User menu provides Light/Dark theme toggle; preference is persisted to user_preferences table and applied on load</ac>
    <ac id="7" fr="FR32">Shell is responsive: sidebar collapses to icon-only mode on mobile (&lt;768px); touch targets are ≥44px</ac>
    <ac id="8" fr="FR32,NFR-PWA">Mobile displays graceful offline banner when network is unavailable; cached navigation still works</ac>
    <ac id="9" fr="Architecture">Hover prefetching enabled for sidebar items to improve perceived performance</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/architecture.md" title="Architecture" section="Implementation Patterns - Frontend Islands" snippet="Shell is Astro SSG with React islands for interactive components. Use Nano Stores for cross-island state. View Transitions for client-side navigation." />
      <doc path="docs/prd.md" title="PRD" section="FR26-FR32: Shell &amp; Navigation" snippet="Shell displays stable header with user menu and notifications. Collapsible sidebar with 7 category icons. Light/dark mode persisted per user. Responsive mobile design." />
      <doc path="docs/sprint-artifacts/tech-spec-epic-1.md" title="Tech Spec Epic 1" section="Story 1.5" snippet="Shell shows 7 category icons in sidebar. Accordion expand/collapse. Theme toggle persisted. Mobile PWA with offline banner." />
      <doc path="docs/ux-design-specification.md" title="UX Design" section="Shell Design System" snippet="Header with brand logo, user menu, notification bell. Sidebar with category icons, expand/collapse. Mobile drawer pattern. Dark theme default." />
    </docs>
    <code>
      <file path="apps/shell/src/layouts/Layout.astro" kind="layout" reason="Existing layout structure - will be basis for AppShell.astro. Shows header pattern with UserButton." />
      <file path="apps/shell/src/components/UserButton.tsx" kind="component" symbol="UserButton" reason="Existing Clerk user button - shows React island pattern with client:only. Use as reference for UserMenu.tsx." />
      <file path="apps/shell/astro.config.mjs" kind="config" reason="Astro config - needs View Transitions and prefetch enabled. Shows react() and clerk() integrations." />
      <file path="apps/shell/src/middleware.ts" kind="middleware" reason="Auth middleware - shows Clerk session handling pattern." />
      <file path="services/core-api/src/routes/users.ts" kind="route" symbol="usersRoutes" reason="Existing /api/v1/users/me endpoint - add preferences endpoints here. Shows clerkAuthMiddleware pattern." />
      <file path="services/core-api/prisma/schema.prisma" kind="schema" reason="Database schema - needs UserPreferences model added. Shows existing patterns for RLS tables." />
      <file path="packages/ui/src/components/button.tsx" kind="component" symbol="Button" reason="shadcn-style Button - use for sidebar and menu buttons. Shows CVA variant pattern." />
      <file path="packages/ui/src/lib/utils.ts" kind="utility" symbol="cn" reason="Class name utility for Tailwind - use in all components." />
      <file path="packages/ts-schema/src/index.ts" kind="exports" reason="Schema exports - add users.ts export here." />
    </code>
    <dependencies>
      <node>
        <pkg name="astro" version="^5.16.0" />
        <pkg name="react" version="^19.2.0" />
        <pkg name="react-dom" version="^19.2.0" />
        <pkg name="@clerk/astro" version="^2.16.3" />
        <pkg name="@astrojs/react" version="^4.3.1" />
        <pkg name="@astrojs/node" version="^9.5.1" />
        <pkg name="nanostores" version="to-add" note="For cross-island state management" />
        <pkg name="@nanostores/react" version="to-add" note="React bindings for nanostores" />
        <pkg name="lucide-react" version="to-add" note="For category icons (Strategy, Palette, Users, etc.)" />
      </node>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface name="GET /api/v1/users/me" kind="REST" path="services/core-api/src/routes/users.ts">
      <signature>GET /api/v1/users/me → { user: UserMe, organization?: OrgContext, preferences?: UserPreferences }</signature>
      <note>Enhance existing endpoint to include preferences in response</note>
    </interface>
    <interface name="PATCH /api/v1/users/me/preferences" kind="REST" path="services/core-api/src/routes/users.ts">
      <signature>PATCH /api/v1/users/me/preferences { theme?: 'light'|'dark'|'system', email_notifications?: object } → { preferences: UserPreferences }</signature>
      <note>New endpoint for saving user preferences</note>
    </interface>
    <interface name="GET /api/v1/notifications" kind="REST" path="services/core-api/src/routes/notifications.ts">
      <signature>GET /api/v1/notifications?unread_only=true&amp;limit=10 → { notifications: Notification[], unread_count: number }</signature>
      <note>Existing spec in tech-spec - may need to implement or stub</note>
    </interface>
    <interface name="NavigationStore" kind="NanoStore" path="apps/shell/src/stores/navigation.ts">
      <signature>{ expandedCategory: string | null, activeModule: string | null }</signature>
    </interface>
    <interface name="ThemeStore" kind="NanoStore" path="apps/shell/src/stores/theme.ts">
      <signature>{ theme: 'light' | 'dark' | 'system', resolvedTheme: 'light' | 'dark' }</signature>
    </interface>
  </interfaces>

  <constraints>
    <constraint source="Architecture ADR-001" priority="high">Use Astro for shell layout, React islands for interactive components only. Keep JS minimal.</constraint>
    <constraint source="Architecture ADR-003" priority="high">All database operations must set RLS context via set_config('app.current_user_id', ...) before queries.</constraint>
    <constraint source="Tech Spec NFR1" priority="high">Shell must load in &lt;2 seconds on simulated 3G. Use SSG, lazy islands, minimal bundle.</constraint>
    <constraint source="Tech Spec NFR4" priority="medium">WCAG 2.1 AA compliance - keyboard navigation, focus management, proper contrast ratios.</constraint>
    <constraint source="Story 1.4 Learnings" priority="medium">Continue using Clerk text IDs (not UUIDs). Follow existing route patterns in users.ts.</constraint>
    <constraint source="Architecture" priority="medium">Use nanostores for cross-island state, not React Context. Enables state sharing between React islands.</constraint>
    <constraint source="PRD FR28" priority="medium">MVP: Only "Management &amp; Strategy" category active. Others show as locked/disabled until subscription.</constraint>
  </constraints>

  <tests>
    <standards>
      Use Vitest for unit tests (stores, utilities). Playwright for E2E tests (UI interactions, navigation, theme persistence).
      Test files co-located with source: *.test.ts for unit, e2e/ folder for Playwright.
      Integration tests for API endpoints use Vitest with testcontainers for database isolation.
      Target &gt;70% coverage for new code per tech spec.
    </standards>
    <locations>
      <glob>apps/shell/src/**/*.test.ts</glob>
      <glob>apps/shell/e2e/**/*.spec.ts</glob>
      <glob>services/core-api/src/**/*.test.ts</glob>
    </locations>
    <ideas>
      <test ac="1">E2E: Header displays logo, user menu button, notification bell icon</test>
      <test ac="2">E2E: Sidebar shows all 7 category icons with correct labels</test>
      <test ac="3">E2E: Inactive categories appear greyed out and are not clickable</test>
      <test ac="4">E2E: Clicking category expands it; clicking another collapses the first</test>
      <test ac="5">E2E: Navigate between categories without window.performance.navigation.type changing</test>
      <test ac="6">Unit: ThemeStore.setTheme() updates store and triggers API call</test>
      <test ac="6">Integration: PATCH /preferences persists theme and GET /me returns it</test>
      <test ac="7">E2E: Viewport &lt;768px shows sidebar as drawer; touch targets ≥44px measured</test>
      <test ac="8">E2E: Set navigator.onLine=false, verify offline banner appears</test>
      <test ac="9">Unit: Hover on sidebar item triggers prefetch call</test>
    </ideas>
  </tests>

  <previousStoryLearnings source="docs/sprint-artifacts/1-4-organization-creation-provisioning.md">
    <learning type="api-pattern">Follow existing route structure in services/core-api/src/routes/users.ts. Use clerkAuthMiddleware, getPrisma(), problemDetails().</learning>
    <learning type="schema-pattern">Use text IDs (Clerk format) for user references. Add RLS policies for new tables.</learning>
    <learning type="testing">13 unit tests + 14 integration tests passing from Story 1.4. Run full test suite to ensure no regressions.</learning>
    <learning type="type-safety">Export all new types from packages/ts-schema. Run pnpm run typecheck before committing.</learning>
    <learning type="note">OrgSettings table exists with preferences JSON field - but need separate UserPreferences for per-user settings like theme.</learning>
  </previousStoryLearnings>
</story-context>
