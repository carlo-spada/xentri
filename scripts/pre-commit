#!/bin/bash

# Pre-commit hook for Xentri
# Validates documentation consistency before commit
#
# Installation:
#   ln -sf ../../scripts/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

set -e

echo "ğŸ” Running pre-commit checks..."
echo ""

# Check if docs files are staged
STAGED_DOCS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.md$|\.yaml$' || true)

if [ -z "$STAGED_DOCS" ]; then
  echo "âœ… No documentation changes staged"
  exit 0
fi

echo "ğŸ“ Documentation changes detected:"
echo "$STAGED_DOCS" | sed 's/^/   /'
echo ""

# Run link validation on staged docs
echo "ğŸ”— Validating links..."
if ! node scripts/validation/validate-links.js 2>/dev/null; then
  echo ""
  echo "âŒ Link validation failed. Fix broken links before committing."
  echo "   Run: pnpm run validate:links"
  exit 1
fi

# Run frontmatter validation if Constitution docs changed
CONSTITUTION_CHANGED=$(echo "$STAGED_DOCS" | grep -E '^docs/platform/(prd|architecture|ux-design|epics|product-soul)\.md$' || true)

if [ -n "$CONSTITUTION_CHANGED" ]; then
  echo ""
  echo "ğŸ“‹ Constitution documents changed, validating frontmatter..."
  if ! node scripts/validation/validate-docs.js 2>/dev/null; then
    echo ""
    echo "âŒ Frontmatter validation failed. Fix issues before committing."
    echo "   Run: pnpm run validate:docs"
    exit 1
  fi
fi

echo ""
echo "âœ… All pre-commit checks passed!"
