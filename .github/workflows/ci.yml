name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # version read from package.json "packageManager" field

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm run lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # version read from package.json "packageManager" field

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript check
        run: pnpm run typecheck

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # version read from package.json "packageManager" field

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: pnpm run test -- --coverage
        # NFR29: Coverage thresholds (70%) enforced in vitest.config.ts
        # Test command fails if coverage falls below thresholds

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # version read from package.json "packageManager" field

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm run build

  smoke:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: [build]
    services:
      postgres:
        image: postgres:16.11
        env:
          POSTGRES_USER: xentri
          POSTGRES_PASSWORD: xentri_dev
          POSTGRES_DB: xentri
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:8.4.0
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # version read from package.json "packageManager" field

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm run build

      - name: Start core-api (background)
        run: |
          export DATABASE_URL="postgresql://xentri:xentri_dev@localhost:5432/xentri"
          PORT=3000 HOST=0.0.0.0 \
          CLERK_SECRET_KEY=test CLERK_PUBLISHABLE_KEY=test \
          pnpm --filter @xentri/core-api start &
          echo $! > core_api_pid

      - name: Start shell (background)
        run: |
          PUBLIC_CLERK_PUBLISHABLE_KEY=test pnpm --filter @xentri/shell preview --host --port 4321 &
          echo $! > shell_pid

      - name: Wait for services
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:3000/api/v1/health && curl -sf http://localhost:4321 > /dev/null; then
              echo "Services are up"
              exit 0
            fi
            echo "Waiting for services... ($i/30)"
            sleep 3
          done
          echo "Services did not start in time"
          exit 1

      - name: Run smoke tests
        run: pnpm run test:smoke
        env:
          DATABASE_URL: postgresql://xentri:xentri_dev@localhost:5432/xentri
          API_URL: http://localhost:3000
          SHELL_URL: http://localhost:4321
          REDIS_URL: redis://localhost:6379

  # =============================================================================
  # DEPLOYMENT GATE (per ADR-004: Railway Bootstrap Strategy)
  # =============================================================================
  # Flow: PR checks → merge to main → staging deploy → staging tests → production
  # Railway auto-deploys on push to main. This job gates that deploy is safe.
  # =============================================================================

  staging-gate:
    name: Staging Deploy Gate
    runs-on: ubuntu-latest
    needs: [smoke]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Staging Deployment Ready
        run: |
          echo "============================================="
          echo "  STAGING DEPLOYMENT GATE PASSED"
          echo "============================================="
          echo ""
          echo "All checks passed:"
          echo "  - Lint"
          echo "  - Type Check"
          echo "  - Unit Tests"
          echo "  - Build"
          echo "  - Smoke Tests (RLS isolation verified)"
          echo ""
          echo "Railway will now auto-deploy to staging."
          echo "Monitor at: https://railway.app/project/xentri"
          echo ""
          echo "Next: Run E2E tests against staging before production."
          echo "============================================="

      # Future: Add Railway CLI deploy to staging here
      # - name: Deploy to Staging
      #   uses: railwayapp/railway-deploy@v1
      #   with:
      #     environment: staging
      #     service: core-api
      #   env:
      #     RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # =============================================================================
  # PRODUCTION GATE (manual approval recommended)
  # =============================================================================
  # Once staging is verified, production auto-deploys via Railway.
  # Consider adding GitHub Environment protection rules for production.
  # =============================================================================

  production-ready:
    name: Production Ready
    runs-on: ubuntu-latest
    needs: [staging-gate]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    # Optional: Add environment protection rules in GitHub repo settings
    # environment:
    #   name: production
    #   url: https://xentri.com
    steps:
      - name: Production Deployment Status
        run: |
          echo "============================================="
          echo "  PRODUCTION DEPLOYMENT CLEARED"
          echo "============================================="
          echo ""
          echo "All gates passed. Railway will auto-deploy to production."
          echo ""
          echo "Verification endpoints:"
          echo "  - API Health: https://api.xentri.com/api/v1/health"
          echo "  - Shell: https://xentri.com"
          echo "  - n8n: https://n8n.xentri.com"
          echo ""
          echo "============================================="
